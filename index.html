<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Summoning Statistics</title>
    <link href="StyleSheet.css" rel="stylesheet">
    <link rel="icon" sizes="128x128" type="image/x-icon" href="favicon.ico">
    <script id="worker" type="javascript/worker">
    self.onmessage = function (e) {
    const g = e.data.goal;
    const wanted = e.data.wanted;
    const pityCount_initial = e.data.pityCount;
    let epitomized = e.data.gcCounter;
    const {_rate5, _rate4, _pity5, _pity4, gc_initial} = Banner(e.data.gcCheck , g , epitomized);
    const n = e.data.n;
    const pog = e.data.n/100;
    const sgCount_initial = e.data.sgCount;
    const offbanner_initial = e.data.offbanner;
    const checking = e.data.sgUse;
    const c5s = e.data.c5s;
    const c4s1 = e.data.c4s1;
    const c4s2 = e.data.c4s2;
    const c4s3 = e.data.c4s3;

    if ( e.data.wanted_w != null){
        var wanted_w = e.data.wanted_w;
        var pityCount_initial_w = e.data.pityCount_w;
        if ( !e.data.gcCheck_w ) {
            epitomized = 0;
        }
    }

    let prob5 = 0;
    let prob4 = 0;
    let pullsResult = [0];
    
    for (let j = 0; j < n; j++){
        let gc = gc_initial;
        let counter5 = pityCount_initial;
        let counter4 = 1;
        let starglitters = sgCount_initial;
        let pulls = 0;
        let promoted = 0;
        let fs1 = 0, fs2 = 0, fs3 = 0;
        let offbanner = offbanner_initial ? 1 : 0;
        
        while (promoted < wanted) {
            pulls += 1;
            if (checking && starglitters >= 5) {
                pulls -= 1;
                starglitters -= 5;
            }
            prob5 = Math.min(1, _rate5 + Math.max(0, (counter5 - _pity5) * 10 * _rate5));
            prob4 = Math.min(1, _rate4 + Math.max(0, (counter4 - _pity4) * 10 * _rate4));
            let x = Math.random();
            if (x < prob5) {
                if(g == 0 || g == 2){
                    if (x <= prob5/2 || gc == 1){
                        gc = 0;
                        promoted += 1;
                        starglitters += GetStarglitter(5, promoted + c5s);
                    } else {
                        gc += 1;
                        starglitters += 5;
                    }
                } else if (g == 1){
                    if (offbanner == 1) { x*=0.75; }
                    if (x <= prob5*0.375 || gc == 2){
                        gc = 0;
                        promoted += 1;
                    } else {
                        gc += 1;
                    }
                    x > prob5*0.75 ? offbanner += 1 : offbanner = 0;
                    starglitters += 10;
                }
                counter5 = 1;
                counter4 += 1;
            } else if ( x < prob4 + prob5) {
                counter5 += 1;
                counter4 = 1;
                if (g == 0 || g == 2){
                    if ( x < (prob4+prob5)/3/2 ){
                        starglitters += GetStarglitter(4, fs1 + c4s1);
                        fs1 += 1;
                    } else if (x < (prob4+prob5)/3 ){
                        starglitters += GetStarglitter(4, fs2 + c4s2);
                        fs2 += 1;
                    } else if (x < (prob4+prob5)/2 ) {
                        starglitters += GetStarglitter(4, fs3 + c4s3);
                        fs3 += 1;
                    } else { starglitters += 2 ;}
                }
                else if (g == 1){starglitters += 2;}
            } else {
                counter5 += 1;
                counter4 += 1;
            }
        }
        if(g==2){
            gc = epitomized;
            counter5 = pityCount_initial_w;
            counter4 = 1;
            promoted = 0;
            while ( promoted < wanted_w ){
                pulls += 1;
                if (checking && starglitters >= 5) {
                    pulls -= 1;
                    starglitters -= 5;
                }
                prob5 = Math.min(1, 0.007 + Math.max(0, (counter5 - 62) * 10 * 0.007));
                prob4 = Math.min(1, 0.06 + Math.max(0, (counter4 - 7) * 10 * 0.06));
                let x = Math.random();
                if (x < prob5) {
                    if (offbanner == 1) { x*=0.75; }
                    if (x <= prob5*0.375 || gc == 2){
                        gc = 0;
                        promoted += 1;
                    } else {
                        gc += 1;
                    }
                    x > prob5*0.75 ? offbanner += 1 : offbanner = 0;
                    starglitters += 10;
                    counter5 = 1;
                    counter4 += 1;
                } else if ( x < prob4 + prob5) {
                    counter5 += 1;
                    counter4 = 1;
                    starglitters += 2;
                } else {
                    counter5 += 1;
                    counter4 += 1;
                }
            }
        }
        if (pullsResult[pulls] == null){
            for (let k = pullsResult.length; k <= pulls; k++){
                pullsResult.push(0);
            }
        }
        pullsResult[pulls] += 1;
        if (j % pog == 0) {
            postMessage({ progress : (j + pog)/pog });
        }
    }
    postMessage({
        pullsResult : pullsResult
    });
}

function GetStarglitter(star, count){
    if ( star == 5){
        if ( count == -1 ) {
            return 0;
        } else if ( count >= 0 && count < 6 ) {
            return 10;
        } else { return 25;}
    } else if ( star == 4 ){
        if ( count == -1 ) {
            return 0;
        } else if ( count >= 0 && count < 6 ) {
            return 2;
        } else { return 5;}
    }
}

function Banner(u, v, w){
    let _rate5 = 0.006;
    let _rate4 = 0.051;
    let _pity5 = 73;
    let _pity4 = 8;
    let gc_initial = u ? 1: 0;
    if (v == 1){
        _rate5 = 0.007;
        _rate4 = 0.06;
        _pity5 = 62;
        _pity4 = 7;
        gc_initial = w;
    }
    return {_rate5, _rate4, _pity5, _pity4, gc_initial};
}
    </script>
    <script id="worker2" type="javascript/worker">
    self.onmessage = function (e) {
    const g = e.data.goal;
    const wanted = e.data.wanted;
    const pityCount_initial = e.data.pityCount;
    let epitomized = e.data.gcCounter;
    const {_rate5, _rate4, _pity5, _pity4, gc_initial} = Banner(e.data.gcCheck , g , epitomized);
    const n = e.data.n;
    const sgCount_initial = e.data.sgCount;
    const offbanner_initial = e.data.offbanner;
    const checking = e.data.sgUse;
    const c5s = e.data.c5s;
    const c4s1 = e.data.c4s1;
    const c4s2 = e.data.c4s2;
    const c4s3 = e.data.c4s3;

    if ( e.data.wanted_w != null){
        var wanted_w = e.data.wanted_w;
        var pityCount_initial_w = e.data.pityCount_w;
        if ( !e.data.gcCheck_w ) {
            epitomized = 0;
        }
    }

    let prob5 = 0;
    let prob4 = 0;
    let pullsResult = [0];
    
    for (let j = 0; j < n; j++){
        let gc = gc_initial;
        let counter5 = pityCount_initial;
        let counter4 = 1;
        let starglitters = sgCount_initial;
        let pulls = 0;
        let promoted = 0;
        let fs1 = 0, fs2 = 0, fs3 = 0;
        let offbanner = offbanner_initial ? 1 : 0;
        
        while (promoted < wanted) {
            pulls += 1;
            if (checking && starglitters >= 5) {
                pulls -= 1;
                starglitters -= 5;
            }
            prob5 = Math.min(1, _rate5 + Math.max(0, (counter5 - _pity5) * 10 * _rate5));
            prob4 = Math.min(1, _rate4 + Math.max(0, (counter4 - _pity4) * 10 * _rate4));
            let x = Math.random();
            if (x < prob5) {
                if(g == 0 || g == 2){
                    if (x <= prob5/2 || gc == 1){
                        gc = 0;
                        promoted += 1;
                        starglitters += GetStarglitter(5, promoted + c5s);
                    } else {
                        gc += 1;
                        starglitters += 5;
                    }
                } else if (g == 1){
                    if (offbanner == 1) { x*=0.75; }
                    if (x <= prob5*0.375 || gc == 2){
                        gc = 0;
                        promoted += 1;
                    } else {
                        gc += 1;
                    }
                    x > prob5*0.75 ? offbanner += 1 : offbanner = 0;
                    starglitters += 10;
                }
                counter5 = 1;
                counter4 += 1;
            } else if ( x < prob4 + prob5) {
                counter5 += 1;
                counter4 = 1;
                if (g == 0 || g == 2){
                    if ( x < (prob4+prob5)/3/2 ){
                        starglitters += GetStarglitter(4, fs1 + c4s1);
                        fs1 += 1;
                    } else if (x < (prob4+prob5)/3 ){
                        starglitters += GetStarglitter(4, fs2 + c4s2);
                        fs2 += 1;
                    } else if (x < (prob4+prob5)/2 ) {
                        starglitters += GetStarglitter(4, fs3 + c4s3);
                        fs3 += 1;
                    } else { starglitters += 2 ;}
                }
                else if (g == 1){starglitters += 2;}
            } else {
                counter5 += 1;
                counter4 += 1;
            }
        }
        if(g==2){
            gc = epitomized;
            counter5 = pityCount_initial_w;
            counter4 = 1;
            promoted = 0;
            while ( promoted < wanted_w ){
                pulls += 1;
                if (checking && starglitters >= 5) {
                    pulls -= 1;
                    starglitters -= 5;
                }
                prob5 = Math.min(1, 0.007 + Math.max(0, (counter5 - 62) * 10 * 0.007));
                prob4 = Math.min(1, 0.06 + Math.max(0, (counter4 - 7) * 10 * 0.06));
                let x = Math.random();
                if (x < prob5) {
                    if (offbanner == 1) { x*=0.75; }
                    if (x <= prob5*0.375 || gc == 2){
                        gc = 0;
                        promoted += 1;
                    } else {
                        gc += 1;
                    }
                    x > prob5*0.75 ? offbanner += 1 : offbanner = 0;
                    starglitters += 10;
                    counter5 = 1;
                    counter4 += 1;
                } else if ( x < prob4 + prob5) {
                    counter5 += 1;
                    counter4 = 1;
                    starglitters += 2;
                } else {
                    counter5 += 1;
                    counter4 += 1;
                }
            }
        }
        if (pullsResult[pulls] == null){
            for (let k = pullsResult.length; k <= pulls; k++){
                pullsResult.push(0);
            }
        }
        pullsResult[pulls] += 1;
    }
    postMessage({
        pullsResult : pullsResult
    });
}

function GetStarglitter(star, count){
    if ( star == 5){
        if ( count == -1 ) {
            return 0;
        } else if ( count >= 0 && count < 6 ) {
            return 10;
        } else { return 25;}
    } else if ( star == 4 ){
        if ( count == -1 ) {
            return 0;
        } else if ( count >= 0 && count < 6 ) {
            return 2;
        } else { return 5;}
    }
}

function Banner(u, v, w){
    let _rate5 = 0.006;
    let _rate4 = 0.051;
    let _pity5 = 73;
    let _pity4 = 8;
    let gc_initial = u ? 1: 0;
    if (v == 1){
        _rate5 = 0.007;
        _rate4 = 0.06;
        _pity5 = 62;
        _pity4 = 7;
        gc_initial = w;
    }
    return {_rate5, _rate4, _pity5, _pity4, gc_initial};
}
    </script>
    <script src="script.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
</head>

<body>
    <div id="body">
        <header style="text-align: right">
            <a href="about/" style="color:#0645AD;">About</a>
            |
            <a href="changelog/" style="color:#0645AD;">Changelog</a>
            | v1.5
        </header>
        <h3>Statistics for Genshin Impacts wishing system</h3>
        <div id="content">
            <div id="Banner Type">
                <select id="goal" style="color: #686868;">
                    <option value="0">Character Banner</option>
                    <option value="1">Weapon Banner</option>
                    <option value="2">Character + Weapon Banner</option>
                </select>
            </div>
            <div id="selection" style="display: block;">
                <div id="focus count">
                    <label for="focus_count">5☆ goal:</label>
                    <input id="focus_count" type="number" class="small_number" value="1" min="0" max="7" required="true">
                </div>
                <div>
                    <div class="tooltip">
                        <label for="pity_count">Current 5☆ pity:</label>
                        <span id="tooltiptext" class="tooltiptext">0 - 89</span>
                    </div>
                    <input id="pity_count" type="number" class="large_number" value="0" min="0" max="89" required="true">
                </div><div>
                    <label for="gcCheck">Guaranteed pity?</label>
                    <input id="gcCheck" type="checkbox" class="form-check-input">
                </div>
                <div id="wpity" style="display: none;">
                    <label for="gcCounter" class="form-check-label">Epitomized Path:</label>
                    <input id="gcCounter" type="number" class="small_number" value="0" min="0" max="2">
                    <label for="offbanner">&nbsp;Last 5☆ was off banner? :</label>
                    <input id="offbanner" type="checkbox" class="form-check-input">
                </div>
            </div>
            <div id="selection2" style="display: none; width: 100%; float: left;">
                <div style="float: left; width: 100%;">
                    <div class="left-character">
                        <p style="text-decoration: underline; margin: 0px;">Character Banner:</p>
                        <div id="focus count_c">
                            <label for="focus_count_c">5☆ goal:</label>
                            <input id="focus_count_c" type="number" class="small_number" value="1" min="0" max="7" required="true">
                        </div>
                        <div>
                            <div class="tooltip">
                                <label for="pity_count_c">5☆ pity:</label>
                                <span id="tooltiptext" class="tooltiptext">0 - 89</span>
                            </div>
                            <input id="pity_count_c" type="number" class="large_number" value="0" min="0" max="89" required="true">
                        </div><div style="margin-bottom: 2px;">
                            <label for="gcCheck_c">Guaranteed pity?</label>
                            <input id="gcCheck_c" type="checkbox" class="form-check-input">
                        </div>
                    </div>
                    <div class="right-weapon">
                        <p style="text-decoration: underline; margin: 0px;">Weapon Banner:</p>
                        <div id="focus count_w">
                            <label for="focus_count_w">5☆ goal:</label>
                            <input id="focus_count_w" type="number" class="small_number" value="1" min="0" required="true">
                        </div>
                        <div>
                            <div class="tooltip">
                                <label for="pity_count_w">5☆ pity:</label>
                                <span id="tooltiptext" class="tooltiptext">0 - 79</span>
                            </div>
                            <input id="pity_count_w" type="number" class="large_number" value="0" min="0" max="79" required="true">
                        </div><div>
                            <label for="gcCheck_w">Guaranteed pity?</label>
                            <input id="gcCheck_w" type="checkbox" class="form-check-input">
                        </div>
                        <div id="wpity_w" style="display: none;">
                            <label for="gcCounter_w" class="form-check-label">Epitomized Path:</label>
                            <input id="gcCounter_w" type="number" class="small_number" value="0" min="0" max="2">
                            <br>
                            <label for="offbanner_w">Last 5☆ was off banner?</label>
                            <input id="offbanner_w" type="checkbox" class="form-check-input">
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <label for="sg_use">Use Starglitter?</label>
                <input id="sg_use" type="checkbox" class="form-check-input">
            </div>
            <div id="starglitter" style="display: none;">
                <hr/>
                <div>
                    <label for="sg_count">Current Starglitter count</label>
                    <input id="sg_count" value="0" min="0" type="number" class="large_number"></input>
                </div>
                <div id="const_input">
                    <label>Enter constellations for your characters:</label>
                    <div>
                        <label for="5s_c">5☆:</label>
                        <input id="5s_c" type="number" class="small_number" value="-1" min="-1" max="6">
                        <label for="4s1">&nbsp;&nbsp;&nbsp;First 4☆:</label>
                        <input id="4s1" type="number" class="small_number" value="-1" min="-1" max="6">
                        <label for="4s2">&nbsp;&nbsp;&nbsp;Second 4☆:</label>
                        <input id="4s2" type="number" class="small_number" value="-1" min="-1" max="6">
                        <label for="4s3">&nbsp;&nbsp;&nbsp;Third 4☆:</label>
                        <input id="4s3" type="number" class="small_number" value="-1" min="-1" max="6">
                    </div>
                    <div id="const_note">
                        <label for="const_note">&nbsp;&nbsp;&nbsp;&nbsp;<em>Note: constellation </em>"-1"<em> means you don't own the character yet.</em></label>
                    </div>
                </div>
                <hr/>
            </div>
            <div id="simul_button" style="margin-bottom: 10px; float: left; width: 100%;">
                <button type="button" id="runButton" class="btn btn-primary mt-2" style="color: #686868; border-radius: 5px; border-width: 1px; height: 21px;">Run</button>
            </div>
            <div class="container" style="float: left; width: 100%;">
                <canvas id="myChart" width="720" height="455"></canvas>
            </div>
            <div id="myProgress" style="position : relative; display: none; float: left; width: 100%;">
                <div id="myBarBackground" style="position : absolute; top:0; left:0;"></div>
                <div id="myBar" style="position : absolute; top:0; left:0;"></div>
                <div id="myBarText" style="position : absolute; top:0; left:0;">0%</div>
            </div>
            <div style="float: left; width: 100%;">
                <label id="sample" style="font-size: 14px;">&nbsp;&nbsp;&nbsp;Sample size: 0</label>
                <button type="button" id="switch" class="btn">⇋</button>
            </div>
            <div style="font-size: 14px;">
                <label>&nbsp;&nbsp;&nbsp;Set sample interval:&nbsp;&nbsp;</label>
                <button type="button" id="-" class="btn" style="padding: 0px 4px 0px 4px;">-</button>
                <div style="display: inline-block; text-align: center; width: 4.5em;">
                    <label id="sampleSize" style="font-size: 14px;"></label>
                </div>
                <button type="button" id="+" class="btn" style="padding: 0px 4px 0px 4px;">+</button>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js@3.6.0/dist/chart.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
            <script src="chart.js" type="text/javascript"></script>
        </div>
    </div>
</body>

</html>
